# SpatialCheckProMax 아키텍처 설계서

| 항목 | 내용 |
|------|------|
| 문서 버전 | 2.0 |
| 작성일 | 2025년 12월 |
| 최종 수정 | 2026-01-04 (AI 기능 추가) |
| 작성자 | (주)우리강산시스템 |

---

## 1. 문서 개요

### 1.1 목적

본 문서는 SpatialCheckProMax(국가기본도 DB 검수 시스템)의 소프트웨어 아키텍처를 기술합니다. 시스템의 전체 구조, 컴포넌트 간 관계, 데이터 흐름, 설계 원칙 등을 설명하여 개발자와 유지보수 담당자가 시스템을 이해하고 확장할 수 있도록 합니다.

### 1.2 범위

- 시스템 전체 아키텍처
- 계층 구조 및 컴포넌트 설계
- 검수 프로세스 흐름
- 데이터 모델 및 저장소 구조
- 성능 최적화 설계
- 확장성 및 유지보수성

### 1.3 용어 정의

| 용어 | 정의 |
|------|------|
| FGDB | File Geodatabase, Esri 파일 지오데이터베이스 형식 |
| GDAL | Geospatial Data Abstraction Library, 공간 데이터 처리 라이브러리 |
| NTS | NetTopologySuite, .NET용 지오메트리 연산 라이브러리 |
| QC_ERRORS | 검수 오류 저장 테이블 |
| WKT | Well-Known Text, 지오메트리 텍스트 표현 형식 |
| ONNX | Open Neural Network Exchange, AI 모델 교환 형식 (v2.0) |
| GNN | Graph Neural Network, 그래프 신경망 (v2.0) |

---

## 2. 시스템 개요

### 2.1 시스템 목적

SpatialCheckProMax는 국가기본도 DB의 공간 데이터 품질을 보증하기 위한 6단계 자동화 검수 시스템입니다.

### 2.2 주요 기능

| 기능 | 설명 |
|------|------|
| 테이블 검수 | 테이블 존재 여부, 좌표계, 지오메트리 타입 검증 |
| 스키마 검수 | 컬럼 구조, 데이터 타입, 제약조건 검증 |
| 지오메트리 검수 | 중복, 겹침, 꼬임, 슬리버 등 공간 오류 검출 |
| 속성 검수 | 속성값 유효성, 코드리스트 준수 검증 |
| 관계 검수 | 레이어 간 공간 관계 검증 |
| 보고서 생성 | PDF/HTML 형식 검수 결과 보고서 |
| **AI 자동 수정** | AI 기반 지오메트리 오류 자동 수정 (v2.0 신규) |

### 2.3 시스템 컨텍스트

```
┌─────────────────────────────────────────────────────────────┐
│                     사용자 (검수 담당자)                      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    SpatialCheckProMax GUI                       │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │ 파일 선택   │  │ 검수 실행   │  │ 결과 조회/보고서    │  │
│  └─────────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
          │                 │                    │
          ▼                 ▼                    ▼
┌─────────────┐    ┌─────────────┐    ┌─────────────────────┐
│ FileGDB     │    │ 검수 설정   │    │ 검수 결과           │
│ Shapefile   │    │ (CSV 파일)  │    │ (SQLite/FGDB)       │
│ GeoPackage  │    │             │    │                     │
└─────────────┘    └─────────────┘    └─────────────────────┘
```

---

## 3. 아키텍처 설계

### 3.1 아키텍처 스타일

본 시스템은 **계층형 아키텍처(Layered Architecture)**를 기반으로 설계되었습니다.

### 3.2 계층 구조

```
┌─────────────────────────────────────────────────────────────┐
│                    Presentation Layer                        │
│                 (WPF Views, ViewModels)                      │
├─────────────────────────────────────────────────────────────┤
│                    Application Layer                         │
│          (Services, Orchestration, Workflow)                 │
├─────────────────────────────────────────────────────────────┤
│                    Business Logic Layer                      │
│            (Processors, Validators, Rules)                   │
├─────────────────────────────────────────────────────────────┤
│                    Data Access Layer                         │
│         (GDAL, Entity Framework, CSV Reader)                 │
├─────────────────────────────────────────────────────────────┤
│                    Infrastructure Layer                      │
│          (File System, SQLite, Logging)                      │
└─────────────────────────────────────────────────────────────┘
```

### 3.3 계층별 책임

| 계층 | 책임 | 주요 컴포넌트 |
|------|------|--------------|
| Presentation | 사용자 인터페이스, 입력 처리 | Views, ViewModels, Converters |
| Application | 비즈니스 워크플로우 조율 | SimpleValidationService, ReportService |
| Business Logic | 검수 규칙 실행, 오류 판정 | Processors, Validators |
| Data Access | 데이터 읽기/쓰기 추상화 | DataProviders, ConfigServices |
| Infrastructure | 외부 시스템 연동 | GDAL, SQLite, FileSystem |

---

## 4. 컴포넌트 설계

### 4.1 프로젝트 구조

```
SpatialCheckProMax.sln
│
├── SpatialCheckProMax/                 # 핵심 비즈니스 로직 라이브러리
│   ├── Config/                      # 검수 설정 CSV 파일
│   ├── Constants/                   # 상수 정의
│   ├── Data/                        # Entity Framework Context
│   ├── Exceptions/                  # 커스텀 예외
│   ├── Extensions/                  # 확장 메서드
│   ├── Models/                      # 도메인 모델
│   │   ├── Config/                  # 설정 모델
│   │   ├── Entities/                # DB 엔티티
│   │   └── Enums/                   # 열거형
│   ├── Processors/                  # 검수 프로세서
│   │   └── RelationChecks/          # 관계 검수 전략
│   ├── Resources/                   # 리소스 파일 (v2.0)
│   │   └── Models/                  # AI 모델 파일
│   └── Services/                    # 비즈니스 서비스
│       ├── Ai/                      # AI 서비스 (v2.0)
│       └── IO/                      # 입출력 서비스
│
├── SpatialCheckProMax.GUI/             # WPF GUI 애플리케이션
│   ├── Views/                       # XAML 화면
│   ├── ViewModels/                  # MVVM 뷰모델
│   ├── Services/                    # UI 서비스
│   ├── Converters/                  # 값 변환기
│   ├── Styles/                      # UI 스타일
│   └── Assets/                      # 리소스 파일
│
├── SpatialCheckProMax.Api/             # REST API (선택적)
│
└── SpatialCheckProMax.Tests/           # 단위 테스트
```

### 4.2 핵심 컴포넌트 다이어그램

```
┌─────────────────────────────────────────────────────────────────┐
│                      Presentation Layer                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │
│  │ WelcomeView  │  │ DashboardView│  │ ValidationResultView │   │
│  └──────────────┘  └──────────────┘  └──────────────────────┘   │
│           │               │                    │                 │
│           └───────────────┼────────────────────┘                 │
│                           ▼                                      │
│              ┌─────────────────────────┐                         │
│              │      ViewModels         │                         │
│              └─────────────────────────┘                         │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Application Layer                           │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              SimpleValidationService                      │   │
│  │  (검수 워크플로우 총괄, 단계별 프로세서 조율)              │   │
│  └──────────────────────────────────────────────────────────┘   │
│           │         │         │         │         │              │
│           ▼         ▼         ▼         ▼         ▼              │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Business Logic Layer                          │
│  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌────────┐ │
│  │ Table    │ │ Schema   │ │ Geometry │ │Attribute │ │Relation│ │
│  │ Check    │ │ Check    │ │ Check    │ │ Check    │ │ Check  │ │
│  │ Processor│ │ Processor│ │ Processor│ │ Processor│ │Processor││
│  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └────────┘ │
│       │            │            │            │           │       │
│       └────────────┴────────────┴────────────┴───────────┘       │
│                                  │                               │
│                                  ▼                               │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                  GdalDataAnalysisService                  │   │
│  │              (공간 데이터 분석 통합 서비스)                 │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              AI Layer (v2.0 신규)                         │   │
│  │  ┌────────────────┐  ┌────────────────┐                  │   │
│  │  │ GeometryAi     │  │ GeometryEdit   │                  │   │
│  │  │ Corrector      │  │ ToolService    │                  │   │
│  │  │ (ONNX 추론)    │  │ (수정 통합)    │                  │   │
│  │  └────────────────┘  └────────────────┘                  │   │
│  └──────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Data Access Layer                           │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │
│  │ CsvConfig    │  │ DataSource   │  │ QcErrorData          │   │
│  │ Service      │  │ Pool         │  │ Service              │   │
│  └──────────────┘  └──────────────┘  └──────────────────────┘   │
│         │                 │                    │                 │
│         ▼                 ▼                    ▼                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐   │
│  │ CSV Files    │  │ FileGDB      │  │ SQLite / FGDB        │   │
│  └──────────────┘  └──────────────┘  └──────────────────────┘   │
└─────────────────────────────────────────────────────────────────┘
```

### 4.3 프로세서 인터페이스 설계

```
┌────────────────────────────────────────┐
│         ICheckProcessor                 │
│  <<interface>>                          │
├────────────────────────────────────────┤
│ + ProcessAsync(config, provider,        │
│               progress, token)          │
│   : Task<CheckResult>                   │
└────────────────────────────────────────┘
              △
              │
    ┌─────────┼─────────┬─────────┬─────────┬─────────┐
    │         │         │         │         │         │
┌───┴───┐ ┌───┴───┐ ┌───┴───┐ ┌───┴───┐ ┌───┴───┐
│ITable │ │ISchema│ │IGeom  │ │IAttr  │ │IRel   │
│Check  │ │Check  │ │Check  │ │Check  │ │Check  │
│Proc   │ │Proc   │ │Proc   │ │Proc   │ │Proc   │
└───┬───┘ └───┬───┘ └───┬───┘ └───┬───┘ └───┬───┘
    │         │         │         │         │
┌───┴───┐ ┌───┴───┐ ┌───┴───┐ ┌───┴───┐ ┌───┴───┐
│Table  │ │Schema │ │Geom   │ │Attr   │ │Rel    │
│Check  │ │Check  │ │Check  │ │Check  │ │Check  │
│Proc   │ │Proc   │ │Proc   │ │Proc   │ │Proc   │
└───────┘ └───────┘ └───────┘ └───────┘ └───────┘
```

---

## 5. 데이터 모델

### 5.1 핵심 도메인 모델

```
┌─────────────────────────────────────────────────────────────┐
│                     ValidationResult                         │
├─────────────────────────────────────────────────────────────┤
│ - ValidationId: string                                       │
│ - TargetFile: string                                         │
│ - Status: ValidationStatus                                   │
│ - IsValid: bool                                              │
│ - ErrorCount: int                                            │
│ - WarningCount: int                                          │
│ - ProcessingTime: TimeSpan                                   │
├─────────────────────────────────────────────────────────────┤
│ + TableCheckResult: TableCheckResult                         │
│ + SchemaCheckResult: SchemaCheckResult                       │
│ + GeometryCheckResult: GeometryCheckResult                   │
│ + AttributeCheckResult: AttributeCheckResult                 │
│ + RelationCheckResult: RelationCheckResult                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 1:N
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                        CheckResult                           │
├─────────────────────────────────────────────────────────────┤
│ - CheckId: string                                            │
│ - CheckName: string                                          │
│ - Status: CheckStatus                                        │
│ - TotalChecked: int                                          │
│ - ErrorCount: int                                            │
│ - WarningCount: int                                          │
├─────────────────────────────────────────────────────────────┤
│ + Errors: List<ValidationError>                              │
│ + Warnings: List<ValidationError>                            │
│ + Metadata: Dictionary<string, object>                       │
└─────────────────────────────────────────────────────────────┘
                              │
                              │ 1:N
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      ValidationError                         │
├─────────────────────────────────────────────────────────────┤
│ - ErrorCode: string                                          │
│ - Message: string                                            │
│ - Severity: ErrorSeverity                                    │
│ - TableId: string                                            │
│ - TableName: string                                          │
│ - FeatureId: string                                          │
│ - X: double                                                  │
│ - Y: double                                                  │
│ - GeometryWKT: string                                        │
│ - Metadata: Dictionary<string, object>                       │
└─────────────────────────────────────────────────────────────┘
```

### 5.2 QC_ERRORS 모델

```
┌─────────────────────────────────────────────────────────────┐
│                         QcError                              │
├─────────────────────────────────────────────────────────────┤
│ - GlobalID: string (GUID)                                    │
│ - ErrType: string (GEOM, REL, ATTR, SCHEMA)                  │
│ - ErrCode: string                                            │
│ - Severity: string                                           │
│ - Status: string                                             │
│ - RuleId: string                                             │
│ - TableId: string                                            │
│ - TableName: string                                          │
│ - SourceClass: string                                        │
│ - SourceOID: long                                            │
│ - SourceGlobalID: string                                     │
│ - RelatedTableId: string                                     │
│ - RelatedTableName: string                                   │
│ - X: double                                                  │
│ - Y: double                                                  │
│ - GeometryWKT: string                                        │
│ - Message: string                                            │
│ - DetailsJSON: string                                        │
│ - RunID: string                                              │
│ - CreatedUTC: DateTime                                       │
│ - UpdatedUTC: DateTime                                       │
└─────────────────────────────────────────────────────────────┘
```

### 5.3 설정 모델

| 설정 클래스 | 용도 | 소스 파일 |
|------------|------|----------|
| TableCheckConfig | 테이블 검수 설정 | 1_table_check.csv |
| SchemaCheckConfig | 스키마 검수 설정 | 2_schema_check.csv |
| GeometryCheckConfig | 지오메트리 검수 설정 | 3_geometry_check.csv |
| AttributeCheckConfig | 속성 검수 설정 | 4_attribute_check.csv |
| RelationCheckConfig | 관계 검수 설정 | 5_relation_check.csv |

---

## 6. 검수 프로세스 설계

### 6.1 6단계 검수 흐름

```
┌─────────────────────────────────────────────────────────────┐
│                    검수 시작                                  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  0단계: FileGDB 완전성 검사                                   │
│  - 디렉터리 구조 확인                                         │
│  - 코어 시스템 테이블 존재 확인                                │
│  - .gdbtable/.gdbtablx 페어 확인                             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  1단계: 테이블 검수                                           │
│  - 필수 테이블 존재 여부                                      │
│  - 좌표계(CRS) 일치 여부                                      │
│  - 지오메트리 타입 일치 여부                                   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  2단계: 스키마 검수                                           │
│  - 필수 컬럼 존재 여부                                        │
│  - 데이터 타입 일치 여부                                      │
│  - 길이/제약조건 검증                                         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  3단계: 지오메트리 검수                                       │
│  - 객체 중복 검사                                             │
│  - 객체 간 겹침 검사                                          │
│  - 자체 꼬임(Self-Intersection) 검사                         │
│  - 슬리버 폴리곤 검사                                         │
│  - 짧은 객체/작은 면적 검사                                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  4단계: 속성 검수                                             │
│  - NotNull/NotZero 검사                                      │
│  - 값 범위(Range) 검사                                        │
│  - 코드리스트 검사                                            │
│  - 조건부 검사 (IfCodeThen...)                                │
│  - 정규식 패턴 검사                                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  5단계: 관계 검수                                             │
│  - 폴리곤 간 겹침 금지 검사                                    │
│  - 선형 포함 관계 검사                                        │
│  - 점 포함 관계 검사                                          │
│  - 연결성 검사                                                │
│  - 속성 연속성 검사                                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                    검수 완료                                  │
│  - QC_ERRORS 저장                                            │
│  - 보고서 생성                                                │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 검수 실행 시퀀스

```
사용자          GUI           ValidationService    Processor      GDAL
  │              │                  │                 │             │
  │─FileGDB선택─>│                  │                 │             │
  │              │─ValidateAsync()─>│                 │             │
  │              │                  │                 │             │
  │              │                  │─LoadConfigs()───│             │
  │              │                  │<────────────────│             │
  │              │                  │                 │             │
  │              │                  │                 │             │
  │              │          ┌──────Loop: 각 검수 단계──────┐        │
  │              │          │      │                 │     │        │
  │              │          │      │─ProcessAsync()─>│     │        │
  │              │          │      │                 │─Open─>       │
  │              │          │      │                 │<────│        │
  │              │          │      │                 │──검수수행──>  │
  │              │          │      │<─CheckResult────│     │        │
  │              │          └──────────────────────────────┘        │
  │              │                  │                 │             │
  │              │                  │─SaveQcErrors()──│             │
  │              │                  │─GenerateReport()│             │
  │              │<─ValidationResult│                 │             │
  │<─결과표시────│                  │                 │             │
```

---

## 7. 성능 최적화 설계

### 7.1 병렬 처리 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│              StageParallelProcessingManager                  │
│           (단계별 독립 검수 병렬 실행 관리)                    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│           AdvancedParallelProcessingManager                  │
│         (테이블/피처 레벨 병렬 처리 관리)                      │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  - ExecuteTableParallelProcessingAsync              │   │
│  │  - ExecuteFeatureParallelProcessingAsync            │   │
│  │  - 동적 병렬도 조정                                   │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              CentralizedResourceMonitor                      │
│                  (시스템 자원 모니터링)                        │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  - CPU 사용률 모니터링                                │   │
│  │  - 메모리 사용량 모니터링                              │   │
│  │  - 동적 스레드 수 조절 권고                            │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                 SystemResourceAnalyzer                       │
│               (최적 병렬도/배치 크기 계산)                     │
│                                                             │
│  - GetOptimalParallelism(): 최적 스레드 수                   │
│  - GetOptimalBatchSize(): 최적 배치 크기                     │
│  - GetOptimalMaxMemoryUsage(): 최대 메모리 사용량            │
└─────────────────────────────────────────────────────────────┘
```

### 7.2 캐싱 및 풀링 전략

| 컴포넌트 | 전략 | 목적 |
|---------|------|------|
| DataSourcePool | GDAL DataSource 풀링 | 파일 I/O 오버헤드 감소 |
| DataCacheService | LRU 캐시 | 반복 데이터 접근 최적화 |
| SpatialIndexManager | R-Tree/Quad-Tree 인덱스 | 공간 쿼리 성능 향상 |

### 7.3 공간 인덱싱 설계

```
┌─────────────────────────────────────────────────────────────┐
│                    SpatialIndexManager                       │
│              (공간 인덱스 생성 및 관리)                        │
└─────────────────────────────────────────────────────────────┘
          │                              │
          ▼                              ▼
┌──────────────────────┐    ┌──────────────────────┐
│   RTreeSpatialIndex  │    │  QuadTreeSpatialIndex│
│                      │    │                      │
│  - 대용량 데이터 최적 │    │  - 균등 분포 데이터  │
│  - 범위 쿼리 효율적   │    │  - 메모리 효율적     │
└──────────────────────┘    └──────────────────────┘
```

---

## 8. 의존성 주입 설계

### 8.1 서비스 등록 구조

```csharp
// 서비스 등록 예시 (개념적 표현)
services.AddSingleton<CsvConfigService>();
services.AddSingleton<GdalDataAnalysisService>();
services.AddSingleton<QcErrorService>();
services.AddSingleton<DataSourcePool>();
services.AddSingleton<SpatialIndexManager>();
services.AddSingleton<SystemResourceAnalyzer>();

services.AddTransient<ITableCheckProcessor, TableCheckProcessor>();
services.AddTransient<ISchemaCheckProcessor, SchemaCheckProcessor>();
services.AddTransient<IGeometryCheckProcessor, GeometryCheckProcessor>();
services.AddTransient<IAttributeCheckProcessor, AttributeCheckProcessor>();
services.AddTransient<IRelationCheckProcessor, RelationCheckProcessor>();

services.AddScoped<SimpleValidationService>();
services.AddScoped<ReportService>();
```

### 8.2 서비스 생명주기

| 생명주기 | 서비스 유형 | 예시 |
|---------|------------|------|
| Singleton | 전역 공유 서비스 | CsvConfigService, DataSourcePool |
| Transient | 매번 새 인스턴스 | Processors |
| Scoped | 요청 범위 공유 | ValidationService, ReportService |

---

## 9. 데이터 저장소 설계

### 9.1 저장소 구조

```
┌─────────────────────────────────────────────────────────────┐
│                      Data Storage                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐  ┌─────────────────┐                  │
│  │   설정 파일      │  │   입력 데이터    │                  │
│  │   (CSV)         │  │   (FileGDB)     │                  │
│  │                 │  │                 │                  │
│  │ - 1_table.csv   │  │ - 레이어들      │                  │
│  │ - 2_schema.csv  │  │ - 속성 데이터   │                  │
│  │ - 3_geometry.csv│  │ - 지오메트리    │                  │
│  │ - 4_attribute.csv│ │                 │                  │
│  │ - 5_relation.csv│  │                 │                  │
│  └─────────────────┘  └─────────────────┘                  │
│                                                             │
│  ┌─────────────────┐  ┌─────────────────┐                  │
│  │  내부 DB        │  │  QC 결과        │                  │
│  │  (SQLite)       │  │  (FileGDB)      │                  │
│  │                 │  │                 │                  │
│  │ - 검수 이력     │  │ - QC_Errors_Point│                 │
│  │ - 사용자 설정   │  │ - QC_Errors_Line │                 │
│  │ - 로그          │  │ - QC_Errors_Polygon│               │
│  └─────────────────┘  └─────────────────┘                  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 9.2 QC_ERRORS 테이블 스키마

| 테이블명 | 지오메트리 타입 | 용도 |
|---------|---------------|------|
| QC_Errors_Point | Point | 점형 오류 저장 |
| QC_Errors_Line | LineString | 선형 오류 저장 |
| QC_Errors_Polygon | Polygon | 면형 오류 저장 |

공통 필드:
- ErrCode, TableId, TableName, SourceOID, Message
- RelatedTableId, RelatedTableName (관계 검수용)
- DetailsJSON (상세 정보)

---

## 10. 확장성 설계

### 10.1 새 검수 규칙 추가

CSV 설정 파일 기반으로 코드 수정 없이 새 규칙 추가 가능:

```csv
# 4_attribute_check.csv 예시
RuleId,Enabled,TableId,TableName,FieldName,CheckType,Parameters,Note
NEW_RULE_001,Y,tn_buld,건물,new_field,NotNull,,새 필드 필수값 검사
```

### 10.2 새 프로세서 추가

인터페이스 기반 설계로 새 검수 프로세서 쉽게 추가:

```csharp
public interface ICustomCheckProcessor
{
    Task<CheckResult> ProcessAsync(
        CustomCheckConfig config,
        IValidationDataProvider dataProvider,
        IProgress<(double, string)>? progress,
        CancellationToken token);
}
```

### 10.3 플러그인 확장 포인트

| 확장 포인트 | 방법 |
|------------|------|
| 검수 규칙 | CSV 설정 파일 추가 |
| 검수 프로세서 | ICheckProcessor 구현 |
| 데이터 소스 | IValidationDataProvider 구현 |
| 보고서 형식 | IReportGenerator 구현 |

---

## 11. 보안 설계

### 11.1 보안 컴포넌트

| 컴포넌트 | 기능 |
|---------|------|
| FileSecurityService | 파일 경로 검증, Path Traversal 방지 |
| SecurityMonitoringService | 보안 활동 모니터링 및 로깅 |

### 11.2 보안 원칙

- 허용된 파일 확장자만 처리 (.gdb, .shp, .gpkg)
- 파일 경로 정규화 및 검증
- 사용자 입력 검증
- 보안 이벤트 로깅

---

## 12. 배포 아키텍처

### 12.1 배포 구성

```
SpatialCheckProMax/
├── SpatialCheckProMax.GUI.exe          # 실행 파일
├── SpatialCheckProMax.dll              # 핵심 라이브러리
├── appsettings.json                 # 설정 파일
│
├── Config/                          # 검수 설정
│   ├── 1_table_check.csv
│   ├── 2_schema_check.csv
│   ├── 3_geometry_check.csv
│   ├── 4_attribute_check.csv
│   ├── 5_relation_check.csv
│   ├── geometry_criteria.csv
│   └── codelist.csv
│
├── runtimes/                        # 네이티브 라이브러리
│   └── win-x64/
│       └── native/
│           ├── gdal.dll
│           ├── proj.dll
│           └── [기타 GDAL 의존성]
│
└── logs/                            # 로그 파일
```

### 12.2 배포 옵션

| 배포 방식 | 설명 | 장점 |
|----------|------|------|
| Framework-dependent | .NET 런타임 필요 | 배포 크기 작음 |
| Self-contained | 런타임 포함 | 독립 실행 가능 |

---

## 13. 품질 속성

### 13.1 성능

- 대용량 FileGDB (100만 피처 이상) 처리 지원
- 병렬 처리로 검수 시간 단축
- 메모리 효율적인 스트리밍 처리

### 13.2 확장성

- 인터페이스 기반 프로세서 설계
- CSV 기반 규칙 관리
- 플러그인 구조 지원

### 13.3 유지보수성

- 계층 분리 아키텍처
- 의존성 주입
- 구조화된 로깅

### 13.4 신뢰성

- 예외 처리 및 복구
- 트랜잭션 기반 데이터 저장
- 검수 결과 무결성 보장

---

## 14. AI 아키텍처 (v2.0 신규)

### 14.1 AI 컴포넌트 구조

```
┌─────────────────────────────────────────────────────────────────┐
│                      AI Correction Layer                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              GeometryEditToolService                      │   │
│  │         (AI 수정 워크플로우 조율 서비스)                   │   │
│  │                                                          │   │
│  │  - AutoFixGeometryAsync(): 자동 수정 실행               │   │
│  │  - ValidateGeometryType(): 타입 검증                     │   │
│  │  - ApplyBufferFallback(): Buffer(0) 폴백                │   │
│  └──────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              GeometryAiCorrector                          │   │
│  │            (ONNX 모델 추론 엔진)                          │   │
│  │                                                          │   │
│  │  - Correct(): 단일 지오메트리 수정                        │   │
│  │  - CorrectBatch(): 배치 수정                             │   │
│  │  - GetCorrectionConfidence(): 신뢰도 계산                │   │
│  └──────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              ONNX Runtime                                 │   │
│  │         (Microsoft.ML.OnnxRuntime)                        │   │
│  │                                                          │   │
│  │  - InferenceSession: 모델 세션 관리                       │   │
│  │  - DenseTensor: 입출력 텐서 처리                          │   │
│  └──────────────────────────────────────────────────────────┘   │
│                              │                                   │
│                              ▼                                   │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              geometry_corrector.onnx                      │   │
│  │              (GeometryGNN 학습 모델)                       │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 14.2 AI 모델 입출력 스펙

| 구분 | 이름 | 형상 | 설명 |
|------|------|------|------|
| **입력** | coordinates | [batch, max_vertices, 2] | 좌표 (x, y) |
| **입력** | mask | [batch, max_vertices] | 유효 정점 마스크 |
| **출력** | offsets | [batch, max_vertices, 2] | 보정 오프셋 (dx, dy) |

### 14.3 AI 수정 시퀀스

```
GUI                EditService        AiCorrector        GdalWriter
  │                    │                  │                  │
  │─AutoFixClick()────>│                  │                  │
  │                    │                  │                  │
  │                    │──────────────────│──ReadGeometry()─>│
  │                    │                  │<───Geometry──────│
  │                    │                  │                  │
  │                    │─Correct(geom)───>│                  │
  │                    │                  │─PrepareInput()   │
  │                    │                  │─ONNX.Run()       │
  │                    │                  │─ApplyOffsets()   │
  │                    │<──CorrectedGeom──│                  │
  │                    │                  │                  │
  │                    │─ValidateType()   │                  │
  │                    │─ValidateGeom()   │                  │
  │                    │                  │                  │
  │                    │─────────────────────WriteGeometry()─>│
  │                    │<──────────────────────Success────────│
  │<──FixResult────────│                  │                  │
```

### 14.4 타입 검증 로직

```
원본 타입 추출 (Polygon, LineString, Point 등)
              │
              ▼
      AI 수정 실행
              │
              ▼
    수정된 타입 추출
              │
              ▼
   ┌──────────────────┐
   │ 타입 일치 여부?  │
   └──────────────────┘
          │         │
        일치       불일치
          │         │
          ▼         ▼
    수정 결과     Buffer(0)
      적용        폴백 적용
```

### 14.5 폴백 전략

| 상황 | 폴백 조치 |
|------|----------|
| AI 모델 미로드 | 원본 반환 |
| 정점 수 초과 (>500) | 원본 반환 |
| 타입 변경 발생 | Buffer(0) 적용 |
| 유효하지 않은 결과 | 원본 반환 |
| 추론 오류 발생 | 원본 반환 |

---

## 15. 부록

### 15.1 설계 결정 기록

| 결정 | 근거 |
|------|------|
| WPF 사용 | Windows 전용 데스크톱 앱, 풍부한 UI 지원 |
| GDAL 사용 | 다양한 공간 데이터 형식 지원, 고성능 |
| SQLite 사용 | 경량 내장 DB, 설치 불필요 |
| CSV 설정 | 비개발자도 규칙 수정 가능 |
| ONNX 사용 (v2.0) | 크로스 플랫폼 AI 추론, PyTorch 학습 모델 호환 |
| GNN 아키텍처 (v2.0) | 그래프 구조의 좌표 관계 학습에 적합 |

### 15.2 참고 문서

- SpatialCheckProMax 개발 스택 문서
- SpatialCheckProMax 시스템 매뉴얼
- SpatialCheckProMax 사용법 가이드
- SpatialCheckProMax AI 학습 매뉴얼 (v2.0)

---

**문서 끝**



