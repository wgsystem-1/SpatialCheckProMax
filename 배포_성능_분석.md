# 배포 버전 성능 분석 및 개선 방안

> **버전**: 2.0 | **최종 수정**: 2026-01-04 | **작성자**: (주)우리강산시스템

## 📊 현재 배포 설정 분석

### 릴리즈 빌드 vs 배포 버전 비교

| 항목 | 릴리즈 빌드 | 배포 버전 |
|------|------------|----------|
| **빌드 명령** | `dotnet build -c Release` | `dotnet publish -c Release --self-contained` |
| **최적화** | ✅ 활성화 | ✅ 활성화 (동일) |
| **.NET 런타임** | 시스템 런타임 사용 | Self-contained (포함) |
| **파일 구조** | 여러 파일 | 여러 파일 (`PublishSingleFile=false`) |
| **코드 트리밍** | N/A | ❌ 비활성화 (`PublishTrimmed=false`) |
| **ReadyToRun** | ❌ 비활성화 | ❌ 비활성화 |

### 성능 차이 원인

#### 1. **시작 시간 (Startup Time)**
- **배포 버전이 더 느릴 수 있는 이유:**
  - Self-contained 배포는 .NET 런타임을 포함하므로 초기 로딩 시간 증가
  - 여러 DLL 파일을 순차적으로 로드하는 시간
  - GDAL Native DLL 로딩 시간
  - **AI 모델 초기화 시간** (v2.0 ONNX Runtime 로드)

- **예상 차이:** 약 1~3초 (시스템에 따라 다름, AI 모델 포함 시 증가)

#### 2. **실행 중 성능 (Runtime Performance)**
- **거의 동일해야 함:**
  - 둘 다 Release 구성 사용 → 최적화 동일
  - JIT 컴파일 방식 동일
  - 메모리 할당 패턴 동일

#### 3. **메모리 사용량**
- **배포 버전이 더 클 수 있는 이유:**
  - `PublishTrimmed=false` → 사용하지 않는 코드도 포함
  - Self-contained 런타임 포함

- **예상 차이:** 약 50~100MB 증가

## 🔍 성능 측정 방법

### 벤치마크 테스트

```powershell
# 릴리즈 빌드 성능 측정
Measure-Command {
    Start-Process ".\SpatialCheckProMax.GUI\bin\Release\net9.0-windows\SpatialCheckProMax.GUI.exe" -Wait
}

# 배포 버전 성능 측정
Measure-Command {
    Start-Process ".\publish\SpatialCheckProMax.GUI.exe" -Wait
}
```

### 성능 프로파일링

1. **시작 시간 측정**
   - 애플리케이션 시작부터 UI 표시까지
   - GDAL 초기화 시간
   - **AI 모델 로딩 시간** (v2.0)

2. **검수 성능 측정**
   - 동일한 GDB 파일로 검수 실행
   - 각 단계별 소요 시간 비교

3. **AI 수정 성능 측정** (v2.0)
   - 지오메트리 오류 자동 수정 시간
   - ONNX 추론 속도

## ✅ 성능 개선 방안

### 방안 1: ReadyToRun (R2R) 컴파일 활성화

**효과:**
- 시작 시간 20~40% 단축
- 실행 중 성능 약간 향상

**설정:**
```xml
<PropertyGroup>
  <PublishReadyToRun>true</PublishReadyToRun>
</PropertyGroup>
```

**단점:**
- 빌드 시간 증가
- 파일 크기 약 10~20% 증가

### 방안 2: 코드 트리밍 활성화 (선택적)

**효과:**
- 파일 크기 감소
- 메모리 사용량 감소

**주의사항:**
- GDAL과 같은 네이티브 라이브러리와 호환성 문제 가능
- 리플렉션 사용 코드에서 문제 발생 가능

**설정:**
```xml
<PropertyGroup>
  <PublishTrimmed>true</PublishTrimmed>
  <TrimMode>partial</TrimMode>
</PropertyGroup>
```

### 방안 3: Tiered Compilation 최적화

**효과:**
- 시작 시간 단축
- 실행 중 성능 향상

**설정:**
```xml
<PropertyGroup>
  <TieredCompilation>true</TieredCompilation>
  <TieredCompilationQuickJit>true</TieredCompilationQuickJit>
</PropertyGroup>
```

### 방안 4: GDAL 초기화 최적화

**현재 문제:**
- GDAL 초기화가 시작 시점에 수행됨
- 초기화 시간이 시작 시간에 포함됨

**개선 방안:**
- 지연 초기화 (Lazy Initialization)
- 백그라운드 초기화

### 방안 5: AI 모델 지연 로딩 (v2.0)

**현재 문제:**
- ONNX 모델이 시작 시 로드되어 초기화 시간 증가
- AI 기능 미사용 시에도 로딩됨

**개선 방안:**
- AI 자동 수정 첫 사용 시 모델 로딩 (Lazy Loading)
- 백그라운드 스레드에서 사전 로딩

**설정:**
```csharp
// GeometryAiCorrector에서 Lazy 패턴 사용
private Lazy<InferenceSession> _lazySession;
```

## 📈 권장 설정

### 최적 성능 설정 (권장)

```xml
<PropertyGroup>
  <!-- 기본 설정 -->
  <PublishSingleFile>false</PublishSingleFile>
  <SelfContained>true</SelfContained>
  <RuntimeIdentifier>win-x64</RuntimeIdentifier>
  <PublishTrimmed>false</PublishTrimmed>
  
  <!-- 성능 최적화 -->
  <PublishReadyToRun>true</PublishReadyToRun>
  <TieredCompilation>true</TieredCompilation>
  <TieredCompilationQuickJit>true</TieredCompilationQuickJit>
</PropertyGroup>
```

### 배포 스크립트 수정

```powershell
$publishArgs = @(
    "publish",
    $ProjectPath,
    "-c", $Configuration,
    "-r", $Runtime,
    "--self-contained", "true",
    "-p:PublishSingleFile=false",
    "-p:PublishTrimmed=false",
    "-p:PublishReadyToRun=true",        # 추가
    "-p:TieredCompilation=true",        # 추가
    "-p:TieredCompilationQuickJit=true", # 추가
    "-o", $OutputDir
)
```

## 🎯 결론

### 속도 차이가 합당한가?

**답: 부분적으로 합당합니다.**

1. **시작 시간 차이 (0.5~2초):**
   - ✅ 합당함: Self-contained 배포의 특성상 불가피
   - 개선 가능: ReadyToRun 활성화로 20~40% 단축 가능

2. **실행 중 성능 차이:**
   - ❌ 차이가 크면 비정상: Release 구성이므로 거의 동일해야 함
   - 차이가 크다면 다른 원인 확인 필요 (디스크 I/O, 메모리 등)

3. **권장 조치:**
   - ReadyToRun 활성화로 시작 시간 개선
   - 실제 성능 측정으로 정량적 비교
   - 사용자 환경에서의 차이 확인

### 다음 단계

1. **성능 측정**
   - 릴리즈 빌드와 배포 버전의 실제 성능 측정
   - 시작 시간, 검수 시간 비교
   - **AI 수정 성능 벤치마크** (v2.0)

2. **최적화 적용**
   - ReadyToRun 활성화
   - 필요시 추가 최적화
   - **AI 모델 지연 로딩 고려** (v2.0)

3. **사용자 피드백**
   - 실제 사용 환경에서의 성능 확인
   - 문제 발생 시 추가 조치

---

## 📊 v2.0 AI 기능 성능 참고

### AI 수정 처리 성능

| 항목 | 예상 성능 |
|------|----------|
| 모델 로딩 | 1~2초 (첫 사용 시) |
| 단일 지오메트리 수정 | 10~50ms |
| 배치 수정 (100개) | 500ms~2초 |
| GDB 저장 | 50~100ms/피처 |

### GPU 가속 (선택적)

CUDA 지원 GPU가 있는 경우 ONNX Runtime GPU 패키지로 교체하여 AI 추론 속도를 향상시킬 수 있습니다.

```xml
<!-- GPU 가속 사용 시 -->
<PackageReference Include="Microsoft.ML.OnnxRuntime.Gpu" Version="1.21.1" />
```


